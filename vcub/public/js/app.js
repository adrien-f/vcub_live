// Generated by CoffeeScript 1.4.0
(function() {
  var Vcub,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Vcub = (function() {

    function Vcub() {
      this.to_map = __bind(this.to_map, this);
      Handlebars.registerHelper('lowercase', function(str) {
        return str.toLowerCase();
      });
      this.stations = window.stations;
      this.create_map();
      this.populate_map();
      $('div#stations_list').html(Handlebars.templates['stations_list_template.hbs']({
        stations: this.stations
      }));
      $(document).on('keyup', 'input[name=search]', this.filter);
      $(document).on('click', 'a.station', this.to_map);
    }

    Vcub.prototype.create_map = function() {
      var _this = this;
      this.map = L.map('map').setView([44.837856, -0.578842], 13);
      this.map.locate({
        setView: true,
        maxZoom: 16
      });
      this.map.on('locationfound', function(e) {
        var radius;
        radius = e.accuracy / 2;
        L.marker(e.latlng).addTo(_this.map).bindPopup("Vous vous trouvez à" + radius + " metres de ce point");
        return L.circle(e.latlng, radius).addTo(_this.map);
      });
      this.osm = L.tileLayer('http://{s}.tile.cloudmade.com/d4eab6cbbfa24ccf98980fb8b04ca7a8/1930/256/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 18
      });
      return this.map.addLayer(this.osm);
    };

    Vcub.prototype.populate_map = function() {
      var marker, popup, station, _i, _len, _ref, _results;
      _ref = this.stations;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        station = _ref[_i];
        popup = Handlebars.templates['popup_template.hbs']({
          nom: station.data.NOM,
          nbvelos: station.data.nbvelos,
          nbplaces: station.data.nbplaces
        });
        marker = new L.marker(station.coordinates, {
          icon: new L.DivIcon({
            className: 'leaflet-div-icon ' + station.data['class'],
            iconSize: new L.Point(20, 20)
          })
        }).bindPopup(popup);
        marker['_leaflet_id'] = station.data['GID'];
        _results.push(marker.addTo(this.map));
      }
      return _results;
    };

    Vcub.prototype.filter = function(e) {
      var $el, $list, filter;
      $el = $('input[name=search]');
      $list = $('div#stations_list');
      filter = $el.val().toLowerCase();
      if (filter === '') {
        return $('div#stations_list div').show();
      } else {
        $('div#stations_list div').hide();
        return $('div#stations_list').find('div[data-name*="' + filter + '"]').each(function(i, e) {
          return $(e).css('display', 'block');
        });
      }
    };

    Vcub.prototype.to_map = function(e) {
      var gid;
      gid = $(e.currentTarget).data('gid');
      this.map.panTo(this.map._layers[gid]._latlng);
      return this.map._layers[gid].openPopup();
    };

    return Vcub;

  })();

  $(document).on('ready', function(e) {
    return window.vcub = new Vcub();
  });

}).call(this);
